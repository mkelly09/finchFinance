from django.core.management.base import BaseCommand
from home.models import Expense, Category
from datetime import datetime

class Command(BaseCommand):
    help = "Import expenses for Februaryâ€“May with deduplication and fallback logic"

    def handle(self, *args, **kwargs):
        raw_expenses = [
            ("04-30-2025", "MCAP", "Arnprior Mortgage Principal", """""", 1068.4, "Ottawa"),
            ("04-30-2025", "MCAP", "Arnprior Mortgage Interest", """""", 1319.9, "Ottawa"),
            ("2025-05-01", "Hydro one BPY", "Foxview Hydro", """""", 457.47, "Ottawa"),
            ("2025-05-05", "Enbridge Gas BPY", "Arnprior Heat", """""", 170.0, "Ottawa"),
            ("2025-05-07", "Hydro One BPY", "Arnprior Hydro", """""", 119.32, "Ottawa"),
            ("2025-05-12", "Costco", "groceries", """""", 167.55, "Ottawa"),
            ("2025-05-01", "FOODLAND", "groceries", """""", 154.85, "Ottawa"),
            ("2025-05-02", "Bell Canada", "Arnprior Internet", """""", 79.1, "Ottawa"),
            ("2025-05-09", "Cupboard", "Restaurants", """restaurants""", 40.19, "Ottawa"),
            ("2025-05-10", "stinson", "Gas", """""", 33.67, "Ottawa"),
            ("2025-05-11", "pur simple", "Restaurants", """restaurants""", 104.78, "Ottawa"),
            ("2025-05-14", "walmart", "groceries", """""", 206.25, "Ottawa"),
            ("2025-05-15", "stinson", "Foxview Heat", """""", 275.4, "Ottawa"),
            ("2025-05-15", "WS Transfer", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-05-15", "WS Transfer", "Foxview Insurance", """""", 250.0, "SF"),
            ("2025-05-15", "WS Transfer", "foxview savings", """""", 750.0, "SF"),
            ("2025-05-19", "Alcatraz Island", "misc", """vacation""", 171.18, "SF"),
            ("2025-05-19", "Booking.com hotel", "misc", """vacation""", 532.68, "SF"),
            ("2025-05-19", "Air Canada", "misc", """vacation""", 220.04, "SF"),
            ("2025-05-19", "Hilton", "misc", """vacation""", 535.75, "SF"),
            ("2025-05-19", "ASHES & DIAMONDS", "misc", """vacation""", 540.56, "Ottawa"),
            ("2025-05-19", "TOCK MATTHIASSON", "misc", """vacation""", 203.08, "Ottawa"),
            ("2025-05-19", "Foodland", "groceries", """""", 88.02, "Ottawa"),
            ("2025-05-16", "E transfer", "Foxview Property Tax", """""", 474.0, "Ottawa"),
            ("2025-05-29", "WS Transfer", "Arnprior Rental Tax Withholding (MAIN)", """""", 625.0, "Ottawa"),
            ("2025-05-29", "WS Transfer", "Arnprior Rental Tax Withholding (LOFT)", """""", 400.0, "Ottawa"),
            ("2025-05-31", "WS Transfer", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-05-31", "WS Transfer", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-05-31", "WS Transfer", "foxview savings", """""", 1500.0, "Ottawa"),
            ("2025-03-31", "MCAP SERVICE MTG", "Arnprior Mortgage Principal", """""", 1068.4, "Ottawa"),
            ("2025-03-31", "MCAP SERVICE MTG", "Arnprior Mortgage Interest", """""", 1319.9, "Ottawa"),
            ("2025-04-03", "Hydro One BPY", "Foxview Hydro", """""", 752.07, "Ottawa"),
            ("2025-04-03", "Enbridge Gas", "Arnprior Heat", """""", 170.0, "Ottawa"),
            ("2025-04-09", "Hydro One BPY", "Arnprior Hydro", """""", 139.4, "Ottawa"),
            ("2025-04-11", "Freestyle Barber", "misc", """Haircut""", 38.9, "Ottawa"),
            ("2025-04-03", "Bell Canada", "Arnprior Internet", """""", 79.1, "Ottawa"),
            ("2025-04-04", "Docusign", "misc", """""", 176.28, "Ottawa"),
            ("2025-04-01", "Trip to Dallas", "misc", """""", 1903.02, "Ottawa"),
            ("2025-04-07", "MCDONOUGHS YIG", "groceries", """""", 171.3, "Ottawa"),
            ("2025-04-07", "Ultramar", "gas", """""", 40.02, "Ottawa"),
            ("2025-04-07", "Amazon", "misc", """""", 197.92, "Ottawa"),
            ("2025-04-10", "MCDONOUGHS YIG", "groceries", """""", 143.57, "Ottawa"),
            ("2025-04-11", "Starbucks", "misc", """""", 3.1, "Ottawa"),
            ("2025-04-12", "Home Depot", "misc", """""", 64.58, "Ottawa"),
            ("2025-04-12", "Amazon", "misc", """""", 20.25, "Ottawa"),
            ("2025-04-13", "Wealthsimple", "Arnprior Property Tax", """""", 215.0, "Tolls in Dallas"),
            ("2025-04-13", "Wealthsimple", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-04-13", "Eractoll", "misc", """""", 109.37, "Ottawa"),
            ("2025-04-13", "Stinsons", "Gas", """""", 48.24, "Ottawa"),
            ("2025-04-14", "Foodland", "groceries", """""", 52.0, "Ottawa"),
            ("2025-04-15", "Farmboy", "groceries", """""", 48.39, "Ottawa"),
            ("2025-04-15", "Stinsons", "Foxview Heat", """""", 993.55, "Ottawa"),
            ("2025-04-15", "Costco", "groceries", """""", 180.13, "Ottawa"),
            ("2025-04-21", "E-transfer", "Foxview Internet", """""", 158.2, "Ottawa"),
            ("2025-04-22", "E-transfer", "Foxview Property Tax", """""", 474.0, "Ottawa"),
            ("2025-04-29", "Wealthsimple", "Arnprior Rental Tax Withholding (MAIN)", """""", 625.0, "Ottawa"),
            ("2025-04-29", "Wealthsimple", "Arnprior Rental Tax Withholding (LOFT)", """""", 400.0, "Ottawa"),
            ("2025-04-29", "Wealthsimple", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-04-29", "Wealthsimple", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-03-31", "TD INS", "Arnprior Insurance", """""", 211.46, "Ottawa"),
            ("2025-03-01", "H&M NOLA", "misc", """clothing""", 40.88, "nola"),
            ("2025-03-01", "TST Antoines", "misc", """""", 665.33, "nola"),
            ("2025-03-01", "PAT OBRIENS", "misc", """""", 63.8, "nola"),
            ("2025-03-01", "HOTEL MONTELEONE CAR", "misc", """""", 50.56, "nola"),
            ("2025-03-01", "MAHOGANY JAZZ HALL", "misc", """""", 152.93, "nola"),
            ("2025-03-01", "CREOLE HOUSE", "misc", """""", 167.38, "nola"),
            ("2025-03-02", "THE NEW STAND", "misc", """""", 39.09, "nola"),
            ("2025-03-02", "CURB NOLA TAXI", "misc", """""", 59.35, "nola"),
            ("2025-03-02", "COPA COBANA", "misc", """""", 31.5, "nola"),
            ("2025-03-02", "French Market", "misc", """""", 109.55, "nola"),
            ("2025-03-02", "French Truck Coffee", "misc", """""", 23.91, "nola"),
            ("2025-03-02", "Astor Crowne Plaza", "misc", """""", 6.75, "Ottawa"),
            ("2025-03-02", "New Orleans airport", "misc", """""", 67.34, "Ottawa"),
            ("2025-03-03", "CRANK WORKS BICYCLE", "misc", """bike repair""", 1016.76, "Ottawa"),
            ("2025-03-03", "EL TOREO", "Restaurants", """restaurant""", 104.16, "Ottawa"),
            ("2025-03-04", "Spotify", "misc", """""", 14.34, "Ottawa"),
            ("2025-03-05", "Ocala Chocolate", "Restaurants", """restaurant""", 23.3, "ocala"),
            ("2025-03-05", "Stinson", "Foxview Heat", """""", 687.17, "Ottawa"),
            ("2025-03-06", "WM SUPERCENTER", "groceries", """""", 198.69, "ocala"),
            ("2025-03-06", "Bell Canada", "Arnprior Internet", """""", 79.1, "ocala"),
            ("2025-03-06", "Shell Oil", "Gas", """""", 51.82, "ocala"),
            ("2025-03-08", "WEC Concessions", "misc", """""", 79.97, "ocala"),
            ("2025-03-08", "Walmart", "groceries", """""", 26.77, "ocala"),
            ("2025-03-08", "Walmart", "groceries", """""", 41.3, "ocala"),
            ("2025-03-09", "Fantasy Beachwear clothing", "misc", """""", 78.75, "ocala"),
            ("2025-03-09", "Stellas Old Fashion", "misc", """""", 35.5, "dallas"),
            ("2025-03-10", "Walmart", "groceries", """""", 143.56, "Ottawa"),
            ("2025-03-12", "Spirit airline", "misc", """""", 145.88, "ocala"),
            ("2025-03-13", "Linkedin Premium", "misc", """""", 53.8, "ocala"),
            ("2025-03-14", "topgolf", "misc", """""", 296.29, "ocala"),
            ("2025-03-14", "topgolf", "misc", """""", 71.32, "ocala"),
            ("2025-03-14", "topgolf", "misc", """""", 32.06, "Ottawa"),
            ("2025-03-15", "public", "groceries", """""", 133.88, "ocala"),
            ("2025-03-17", "Stinson", "Foxview Heat", """""", 767.02, "ocala"),
            ("2025-03-17", "LA HACIENDA", "misc", """""", 110.26, "Ottawa"),
            ("2025-03-21", "Public", "groceries", """""", 196.54, "ocala"),
            ("2025-03-21", "FIDO MOBILE", "mobile phone", """""", 76.84, "ocala"),
            ("2025-03-22", "BELLA COSA", "misc", """golf""", 20.26, "ocala"),
            ("2025-03-22", "OCALA PALMS", "misc", """golf""", 144.64, "Ottawa"),
            ("2025-03-23", "Quick King Food", "misc", """""", 13.19, "ocala"),
            ("2025-03-24", "ANNUAL FEE", "misc", """credit card annual fee""", 460.0, "ocala"),
            ("2025-03-23", "LA HACIENDA", "Restaurants", """restaurant""", 86.48, "Ottawa"),
            ("2025-03-23", "TAQUERIA", "Restaurants", """restaurant""", 33.53, "Ottawa"),
            ("2025-03-24", "OCALA PALMS", "misc", """golf""", 138.25, "Ottawa"),
            ("2025-03-25", "Netflix", "misc", """netflix""", 21.46, "Ottawa"),
            ("2025-03-26", "Google one", "misc", """storage""", 4.51, "Ottawa"),
            ("2025-03-27", "CHAT GPT", "misc", """ai chatbot""", 33.13, "ocala"),
            ("2025-03-27", "Apple bill", "misc", """""", 4.51, "nola"),
            ("2025-03-27", "Publix", "groceries", """""", 191.15, "Ottawa"),
            ("2025-03-03", "FX ATM WD", "misc", """""", 155.05, "Ottawa"),
            ("2025-03-03", "CHQ", "Arnprior Snow Removal", """""", 180.8, "Ottawa"),
            ("2025-03-04", "Hydro One BP", "Foxview Hydro", """""", 843.37, "Ottawa"),
            ("2025-03-05", "Enbridge Gas", "Arnprior Heat", """""", 170.0, "Ottawa"),
            ("2025-03-07", "Wealthsimple", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-03-07", "Wealthsimple", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-03-10", "E transfer", "Foxview Property Tax", """""", 474.0, "ocala"),
            ("2025-03-11", "Hydro One BPY", "Arnprior Hydro", """""", 152.13, "Ottawa"),
            ("2025-03-12", "FX ATM WD", "misc", """""", 36.41, "Ottawa"),
            ("2025-03-13", "TD Insurance", "Arnprior Insurance", """""", 211.4, "Ottawa"),
            ("2025-03-20", "E transfer", "Foxview Property Tax", """""", 474.0, "Ottawa"),
            ("2025-03-24", "E transfer", "Foxview Internet", """""", 158.2, "Ottawa"),
            ("2025-03-24", "TD Insurance", "Arnprior Insurance", """""", 106.78, "Ottawa"),
            ("2025-04-08", "Wealthsimple", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-04-08", "Wealthsimple", "Arnprior Rental Tax Withholding (MAIN)", """""", 625.0, "Ottawa"),
            ("2025-04-08", "Wealthsimple", "Arnprior Rental Tax Withholding (LOFT)", """""", 400.0, "Ottawa"),
            ("2025-04-08", "Wealthsimple", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-02-03", "Costco", "groceries", """""", 373.53, "Ottawa"),
            ("2025-02-03", "Hydro One BPY", "Foxview Hydro", """""", 783.7, "Ottawa"),
            ("2025-02-03", "Enbridge Gas", "Arnprior Heat", """""", 170.0, "Ottawa"),
            ("2025-02-03", "Chq clear", "Arnprior Snow Removal", """""", 180.8, "Ottawa"),
            ("2025-02-06", "WS Investments", "extra rrsp cont", """""", 1800.0, "Ottawa"),
            ("2025-02-10", "Costco", "groceries", """""", 308.38, "Ottawa"),
            ("2025-02-10", "Costco", "misc", """Stand mixer""", 400.0, "Ottawa"),
            ("2025-02-10", "Costco", "misc", """hot dogs""", 3.89, "Ottawa"),
            ("2025-02-10", "Hydro One BPY", "Arnprior Hydro", """""", 193.51, "Ottawa"),
            ("2025-02-07", "Sansotei Ramen", "Restaurants", """restaurant""", 77.63, "Ottawa"),
            ("2025-02-09", "Amazon", "misc", """misc""", 120.49, "Ottawa"),
            ("2025-02-09", "Amazon", "misc", """misc""", 16.94, "Ottawa"),
            ("2025-02-10", "BOOKING.COM", "misc", """NWO Hotel""", 1412.83, "Ottawa"),
            ("2025-02-10", "Kindle", "misc", """book""", 11.29, "Ottawa"),
            ("2025-02-10", "Kindle", "misc", """book""", 15.81, "Ottawa"),
            ("2025-02-10", "Kindle", "misc", """book""", 19.2, "Ottawa"),
            ("2025-02-10", "Apple", "misc", """misc""", 15.8, "Ottawa"),
            ("2025-02-14", "WS Investments", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-02-14", "WS Investments", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-02-14", "WS Investments", "extra rrsp cont", """""", 1000.0, "Ottawa"),
            ("2025-02-18", "City of Ottawa", "misc", """parking ticket""", 85.0, "Ottawa"),
            ("2025-02-18", "Teranet POA HAN", "misc", """parking ticket""", 1.48, "Ottawa"),
            ("2025-02-19", "Freestyle Barber", "misc", """Haircut""", 38.9, "Ottawa"),
            ("2025-02-21", "E transfer", "Foxview Internet", """""", 158.2, "Ottawa"),
            ("2025-02-24", "TD Insurance", "Arnprior Insurance", """""", 106.78, "Ottawa"),
            ("2025-02-26", "FX ATM W/D", "misc", """Golf cash WD""", 35.9, "Ottawa"),
            ("2025-02-28", "MCAP Service mtg", "Arnprior Mortgage Principal", """""", 1014.5, "Ottawa"),
            ("2025-02-28", "MCAP Service mtg", "Arnprior Mortgage Interest", """""", 1373.79, "Ottawa"),
            ("2025-02-10", "Spirit Airlines", "misc", """flights NOLA""", 523.5, "Ottawa"),
            ("2025-02-11", "1000 islands", "misc", """nexus""", 4.75, "Ottawa"),
            ("2025-02-11", "Foodland", "groceries", """""", 27.05, "Ottawa"),
            ("2025-02-13", "Linkedin", "misc", """linked in prem""", 26.89, "Ottawa"),
            ("2025-02-14", "Giovannis", "Restaurants", """restaurant""", 570.75, "Ottawa"),
            ("2025-02-15", "Foodland", "groceries", """""", 107.82, "Ottawa"),
            ("2025-02-15", "MCDONOUGHS YIG", "groceries", """""", 66.54, "Ottawa"),
            ("2025-02-15", "ULTRAMAR", "misc", """""", 7.58, "Ottawa"),
            ("2025-02-19", "TIM HORTONS", "Restaurants", """restaurant""", 9.26, "Ottawa"),
            ("2025-02-20", "MCDONOUGHS YIG", "groceries", """""", 118.19, "Ottawa"),
            ("2025-02-21", "CARLETON VET", "misc", """vet""", 129.39, "Ottawa"),
            ("2025-02-21", "FIDO MOBILE", "mobile phone", """""", 100.0, "Ottawa"),
            ("2025-02-22", "THE SWAN RIDEAU", "Restaurants", """restaurant""", 223.51, "Ottawa"),
            ("2025-02-22", "HUNTERS", "Restaurants", """restaurant""", 209.58, "Ottawa"),
            ("2025-02-23", "WALMART SUPER", "groceries", """ocala""", 425.25, "Ottawa"),
            ("2025-02-23", "Circle K", "misc", """""", 2.95, "Ottawa"),
            ("2025-02-23", "Uber Canada", "misc", """""", 42.35, "Ottawa"),
            ("2025-02-23", "YOW Relay", "Restaurants", """restaurant""", 10.32, "Ottawa"),
            ("2025-03-03", "Wealthsimple", "extra rrsp cont", """""", 2000.0, "Ottawa"),
            ("2025-03-07", "Wealthsimple", "Arnprior Property Tax", """""", 215.0, "Ottawa"),
            ("2025-03-07", "Wealthsimple", "Foxview Insurance", """""", 250.0, "Ottawa"),
            ("2025-03-08", "Etransfer", "Foxview Property Tax", """""", 474.0, "Ottawa"),
        ]

        imported_count = 0
        vendor_category_map = {}

        for entry in raw_expenses:
            date_str, vendor, category_name, notes, amount, location = entry
            date = datetime.strptime(date_str, "%m-%d-%Y").date() if "-" in date_str and date_str[2] == "-" else datetime.strptime(date_str, "%Y-%m-%d").date()


            # Avoid duplicates
            if Expense.objects.filter(date=date, vendor_name=vendor, amount=amount).exists():
                continue

            # Find or create category
            category, _ = Category.objects.get_or_create(name=category_name, defaults={"monthly_limit": 0})

            Expense.objects.create(
                date=date,
                vendor_name=vendor,
                category=category,
                amount=amount,
                location=location,
                notes=notes
            )

            imported_count += 1
            vendor_category_map.setdefault(vendor, category.name)

        self.stdout.write(f"âœ… Imported {imported_count} expenses from Februaryâ€“May.")
        self.stdout.write("ðŸ“‹ Vendor-category associations captured:")
        for vendor, cat in vendor_category_map.items():
            self.stdout.write(f"  - {vendor}: {cat}")
