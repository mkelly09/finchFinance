{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container mt-4">
  <div class="row mb-3 align-items-end">
    <div class="col-lg-7">
      <h2>{{ income_category.name }} — Income History</h2>
      {% if has_target %}
        <p class="text-muted mb-0">
          Monthly target: <strong>${{ monthly_target|floatformat:2|intcomma }}</strong>
        </p>
      {% else %}
        <p class="text-muted mb-0">No monthly target set for this category.</p>
      {% endif %}
    </div>

    <div class="col-lg-5 mt-3 mt-lg-0">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-6">
          <label for="month" class="form-label">Anchor month:</label>
          <input type="month" name="month" id="month" class="form-control" value="{{ selected_month }}">
        </div>
        <div class="col-6">
          <label for="range" class="form-label">Range:</label>
          <select name="range" id="range" class="form-select">
            {% for key,label in range_options %}
              <option value="{{ key }}" {% if selected_range == key %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100">Apply</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Chart + total -->
  {{ trend_labels|json_script:"trend-labels" }}
  {{ trend_values|json_script:"trend-values" }}

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-end mb-2">
        <h5 class="card-title mb-0">Income over time</h5>
        <div class="text-muted">
          Total for range: <strong>${{ range_total|floatformat:2|intcomma }}</strong>
        </div>
      </div>
      <canvas id="incomeTrendChart" height="90"></canvas>
    </div>
  </div>

  <!-- Buttons directly under chart -->
  <div class="mb-4">
    <a class="btn btn-outline-secondary" href="{% url 'category_progress' %}?month={{ selected_month }}">← Back to Category Progress</a>
    <a class="btn btn-outline-secondary ms-2" href="{% url 'dashboard' %}?month={{ selected_month }}">← Back to Dashboard</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const labels = JSON.parse(document.getElementById("trend-labels").textContent);
      const values = JSON.parse(document.getElementById("trend-values").textContent);

      const ctx = document.getElementById("incomeTrendChart").getContext("2d");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Monthly total",
            data: values,
            tension: 0,          // <-- straight lines
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { mode: "index", intersect: false }
          },
          interaction: { mode: "index", intersect: false },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });
  </script>

  <!-- Monthly cards -->
  {% for row in month_rows %}
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-end">
          <h5 class="mb-0">{{ row.month|date:"F Y" }}</h5>
          <div class="text-muted">
            Total: <strong>${{ row.total|floatformat:2|intcomma }}</strong>
          </div>
        </div>

        <div class="mt-2">
          <div class="d-flex justify-content-between">
            <div class="text-muted">
              {% if has_target %}
                {{ row.percent }}% of target
              {% else %}
                —
              {% endif %}
            </div>
            <div class="text-muted">
              {% if has_target %}
                ${{ row.total|floatformat:2|intcomma }} / ${{ monthly_target|floatformat:2|intcomma }}
              {% else %}
                ${{ row.total|floatformat:2|intcomma }}
              {% endif %}
            </div>
          </div>
        </div>

        <hr>

        {% if row.incomes %}
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 120px;">Date</th>
                  <th style="width: 140px;">Amount</th>
                  <th style="width: 110px;">Taxable</th>
                  <th style="width: 160px;">Account</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {% for inc in row.incomes %}
                  <tr>
                    <td>{{ inc.date|date:"Y-m-d" }}</td>
                    <td>${{ inc.amount|floatformat:2|intcomma }}</td>
                    <td>{{ inc.taxable|yesno:"Yes,No" }}</td>
                    <td>
                      {% if inc.bank_account %}
                        {{ inc.bank_account.name }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>{{ inc.notes }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No income transactions found for this month.</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}
